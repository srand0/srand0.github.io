---
layout: post
title:  'Architecture!'
subtitle:  '机器人软件框架比较'
date:    '2019-12-27 12:30:00'
background:  /image/post2.jpg
---

## 一、概述

最近研究了一下机器人的软件框架，大致可以归类为：传统的集中式框架、ROS1框架、分布式(ROS2/Apollo)框架。

## 二、集中式框架

### 1.结构

集中式框架即传统的一整套软件集中了所有的功能，开放出一些接口供外部调用。大体的结构如下图所示：

![centralized](/image/posts/2019-12-27/1.centralized.png)

大致可以将框架分为：

* 基础层：提供统一的工具，如TCP通信、参数管理；
* 设备层：用于连接各种传感器，如激光、里程计、驱动器等；
* 算法层：主要用于定位、导航，依赖于设备层，同时提供接口供调度/服务层使用；
* 调度/服务层：调度即提供接口调度所有的设备共同完成一系列的动作，服务层即提供外部通信接口；该层依赖设备、算法层。

### 2.优缺点

这种框架的优点很明显：

1. 结构清晰：整个程序属于单进程多线程程序，内部结构层次分明；
2. 实时性好：内部通信通过指针传递，不存在通信延时等问题；
3. 接口统一：可以提供统一的参数、接口管理；

缺点也同样明显：

1. 耦合度高：由于层级之间有互相依赖关系，所以一旦有某个接口改动，则上下层都有可能有变化，而机器人系统各个传感器的接口都不一样，因此往往牵一发而动全身；另外，不利于多人协作开发。
2. 调试困难：机器人软件往往由于机器人本身的硬件条件限制，无法直接在开发板上开发、测试，所以调试时往往需要将程序进行拷贝、运行，然后分析log，调试起来相当繁琐。
3. 算法测试代价高：该框架往往是使用的某个公司内部的统一接口，如果需要在该框架的基础上测试一些已有的算法，需要相当大的改动，测试代价很高。

## 三、ROS1框架

### 1.结构与原理

ROS框架之所以能够迅速崛起，和他的松耦合的架构是分不开的，其框架大致如下：
![ros1](/image/posts/2019-12-27/2.ROS1.png)

ROS框架最主要的功能是提供进程间通信(IPC)， 通过Master将各个进程（节点）连通，当节点启动时，先连接Master，Master会反馈该节点需要的当前网络的拓扑结构，帮助订阅者和发布者建立连接，之后的通信其实还是通过socket进行进程间通信。

通信时节点之间通过http协议，序列化使用xml格式，基础库几乎都是ROS官方在维护(xmlrpcpp是在xmlrpc开源库的基础上开发)。

### 2.优缺点

该框架的优点如下：

1. 松耦合：通过IPC将各个程序分开，只要保证消息协议不变，就可以完美替代原来的节点；
2. 不限制语言：由于每一个节点都是一个进程，所以各个节点可以使用不同的语言来实现，官方提供了C/C++,python,lisp三种语言的工具；
3. 调试方便：由于使用套接字方式进行进程间通信，因此，该框架也支持远程调试，即可以在机器人本体运行设备节点，在另外一台机器运行算法相关节点，方便进行算法的调试。

缺点如下：

1. 高度依赖Master：由于网络的拓扑结构都存储在Master节点中，因此，一旦Master节点出现问题，则整个通信网络都停止工作。
2. 消息兼容问题：ROS框架使用xml进行序列化，消息结构一旦发生变化，则无法进行通信，兼容性不好；如果新的传感器数据不同，则可能需要修改消息结构，那么订阅者和发布者两端的程序都要进行相应的修改。
3. 延时问题：网络通信肯定会存在延时的问题，机器人实际的运行环境可能网络更差，像激光这样高频(30-40Hz)的数据有可能会有影响。
4. 环境配置：目前ROS1的框架只支持linux，而且不同的版本支持的linux版本也不同，因此实际使用时会有限制。
5. 参数、接口统一问题：由于每个节点都是一个进程，那么就需要考虑各个进程对外开放的参数、接口的统一的问题。

## 四、分布式框架(ROS2/Apollo)

### 1.结构与原理

ROS2框架与Apollo框架类似，都摒弃了ROS1中的Master节点，采用分布式的订阅发布模型，可以简单理解为每个节点都集成了ROS1中的Master节点。结构如下图所示：

![ros2](/image/posts/2019-12-27/3.ROS2.png)

每当有一个节点启动，都会广播自己的信息，让其他节点发现，然后其他已经存在的节点会告知该新节点网络拓扑信息，这样该节点就加入到了该网络中。根据网络拓扑信息，每个节点可以自己找到需要其订阅者与发布者，从而建立连接进行通信。

ROS2和Apollo的相同之处在于通信都依赖于RTPS框架，目前采用的都是开源的FastRTPS库，FastRTPS最核心的功能是实现了DDS，即分布式实时数据分发服务中间件协议（Data Distribution Service），该协议相当于一条计算机总线；不同之处在于ROS2还是采用的XML方式进行序列化，而Apollo采用protobuf进行消息的编码与解码，兼容性更好。

### 2.优缺点

分布式框架相较于ROS1的框架，有以下优点：

1. 分布式：解决了ROS1中严重依赖于Master节点的问题；
2. 消息兼容：Apollo框架通过protobuf解决了消息兼容性的问题，而且通过protobuf同样减少了通信的数据量；
3. 环境兼容：FastRTPS支持linux/windows/macOS等操作系统，因此解决了ROS1中的环境配置问题。
4. 更加开放：ROS2采用了FastRTPS开源库，而不是像ROS1那样自己维护底层库，这样就减少了维护成本，同样也使得其他的开发者从ROS框架中解锁，只需要使用FastRTPS框架即可。

缺点在于：

1. 延时问题：官方明确指明FastRTPS是高性能DDS库，但是是否真正解决了延时的问题还需要实际测试验证。
2. 参数、接口统一：该问题同样存在与分布式框架中，参数的统一管理、服务的启停、接口的管理这些问题都需要在实际场景中解决。

